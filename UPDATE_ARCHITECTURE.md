# 🔄 Система Обновлений - Архитектура и Процесс

## 📊 Архитектура системы

```
┌─────────────────────────────────────────────────────────────┐
│                    БРАУЗЕР ПОЛЬЗОВАТЕЛЯ                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │         update-notifier.js (JavaScript)             │   │
│  ├──────────────────────────────────────────────────────┤   │
│  │ • Периодическая проверка каждые 5 мин               │   │
│  │ • Отображение уведомления                           │   │
│  │ • Обработка кнопок (Обновить/Отклонить)            │   │
│  │ • Хранение отклоненных обновлений в localStorage    │   │
│  └──────────────────────────────────────────────────────┘   │
│                           ↓                                   │
│                    REST API запросы                          │
│                           ↓                                   │
└─────────────────────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                    FLASK ПРИЛОЖЕНИЕ                          │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────────────────────────────────────────┐   │
│  │           app.py (API Endpoints)                    │   │
│  ├──────────────────────────────────────────────────────┤   │
│  │ POST /api/check-update                              │   │
│  │ POST /api/get-update-notification                   │   │
│  │ POST /api/update-application                        │   │
│  │ POST /api/dismiss-update                            │   │
│  └────────────────────┬─────────────────────────────────┘   │
│                       ↓                                       │
│  ┌──────────────────────────────────────────────────────┐   │
│  │      update_manager.py (Логика обновлений)         │   │
│  ├──────────────────────────────────────────────────────┤   │
│  │ • Проверка версий                                   │   │
│  │ • Парсинг GitHub API                                │   │
│  │ • Сравнение версий (X.Y.Z)                          │   │
│  │ • Git pull (загрузка обновлений)                    │   │
│  │ • Управление version.json                           │   │
│  └────────────────────┬─────────────────────────────────┘   │
│                       ↓                                       │
│  ┌──────────────────────────────────────────────────────┐   │
│  │           version.json (Состояние)                  │   │
│  ├──────────────────────────────────────────────────────┤   │
│  │ {                                                    │   │
│  │   "current_version": "1.0.0",                        │   │
│  │   "github_version": "1.1.0",                         │   │
│  │   "update_available": true,                          │   │
│  │   "changelog": "...",                                │   │
│  │   "last_check": "2025-01-15T12:00:00"               │   │
│  │ }                                                    │   │
│  └──────────────────────────────────────────────────────┘   │
│                       ↓                                       │
└─────────────────────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                        GITHUB API                            │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  • Releases API: GET /repos/{owner}/{repo}/releases/latest  │
│  • Commits API: GET /repos/{owner}/{repo}/commits/main      │
│  • README API: GET /repos/{owner}/{repo}/readme             │
│                                                               │
└─────────────────────────────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────┐
│                    GIT РЕПОЗИТОРИЙ                           │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  • git pull origin main  (загрузить обновления)            │
│  • Теги версий (v1.0.0, v1.1.0, v2.0.0)                   │
│  • Release Notes и Changelog                                │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔄 Поток обновления

### Сценарий 1: Проверка обновлений

```
START
  ↓
[JavaScript] Проверить /api/check-update каждые 5 мин
  ↓
[UpdateManager] Получить данные с GitHub API
  ↓
[GitHub] Вернуть последний релиз или информацию о коммитах
  ↓
[UpdateManager] Парсить версию (v1.1.0 → 1.1.0)
  ↓
[UpdateManager] Сравнить версии (1.0.0 < 1.1.0 ?)
  ↓
[UpdateManager] Сохранить в version.json
  ↓
[JavaScript] Получить ответ с API
  ↓
ЕСТЬ ОБНОВЛЕНИЕ? ДА ↓ / НЕТ ↓ (конец)
  ↓                        
[JavaScript] Показать уведомление в top-баре
  ↓
КОНЕЦ
```

### Сценарий 2: Обновление приложения

```
START
  ↓
[Пользователь] Нажимает "Обновить сейчас"
  ↓
[JavaScript] Показать диалог подтверждения
  ↓
ПОЛЬЗОВАТЕЛЬ СОГЛАСЕН? ДА ↓ / НЕТ ↓ (конец)
  ↓
[JavaScript] POST /api/update-application
  ↓
[UpdateManager] Выполнить: git pull origin main
  ↓
[Git] Скачать обновления с GitHub
  ↓
[UpdateManager] Обновить version.json (новая версия)
  ↓
[API] Вернуть success: true
  ↓
[JavaScript] Показать: "Обновление успешно!"
  ↓
[JavaScript] location.reload() (перезагрузить приложение)
  ↓
КОНЕЦ
```

### Сценарий 3: Отклонение уведомления

```
START
  ↓
[Пользователь] Нажимает "Напомнить позже"
  ↓
[JavaScript] Сохранить версию в localStorage (dismissed)
  ↓
[JavaScript] Убрать уведомление (fade out)
  ↓
[При следующей проверке] Проверить: версия в dismissed?
  ↓
ДА? Не показывать / НЕТ? Показать уведомление
  ↓
КОНЕЦ
```

---

## 📱 Состояния уведомления

```
┌─────────────────┐
│    СКРЫТО       │ (hidden)
│  z-index: -1    │
└────────┬────────┘
         │ check-update() обнаружит новую версию
         ↓
┌──────────────────────────────────┐
│  ПОКАЗАНО (SLIDING IN)           │
│  transform: translateY(-100%)     │
│  → transform: translateY(0)       │
└────────┬─────────────────────────┘
         │
    ┌────┴──────────────────────┐
    │                           │
    ↓ Кнопка                   ↓ Кнопка
    │ "Обновить"               │ "Позже"
    │                           │
    ↓                           ↓
┌────────────────┐      ┌──────────────────────┐
│   ОБНОВЛЕНИЕ   │      │   СКРЫТО             │
│   (spinning)   │      │   Версия в dismissed │
│   git pull...  │      │   Повторится при     │
└────┬───────────┘      │   следующей проверке│
     │                  └──────────────────────┘
     ↓ Success
┌─────────────────┐
│  ПЕРЕЗАГРУЗКА   │
│   location.     │
│   reload()      │
└─────────────────┘
```

---

## 🔐 Проверки безопасности

```
REQUEST /api/update-application
    ↓
┌──────────────────────────────────┐
│ ✓ Пользователь аутентифицирован? │
└──────────────────────────────────┘
    │
    ├─ НЕТ → 401 Unauthorized
    │
    ↓ ДА
┌──────────────────────────────────┐
│ ✓ Пользователь администратор?    │
└──────────────────────────────────┘
    │
    ├─ НЕТ → 403 Forbidden
    │
    ↓ ДА
┌──────────────────────────────────┐
│ ✓ GitHub доступен?               │
└──────────────────────────────────┘
    │
    ├─ НЕТ → Error message
    │
    ↓ ДА
┌──────────────────────────────────┐
│ ✓ Git доступен?                  │
└──────────────────────────────────┘
    │
    ├─ НЕТ → Error message
    │
    ↓ ДА
┌──────────────────────────────────┐
│ ✓ Права на запись?               │
└──────────────────────────────────┘
    │
    ├─ НЕТ → Error message
    │
    ↓ ДА
┌──────────────────────────────────┐
│ ✓ Выполнить git pull             │
└──────────────────────────────────┘
```

---

## 📊 Сравнение версий

```
version1 = "1.0.0"
version2 = "1.1.0"

Парсим: [1, 0, 0] vs [1, 1, 0]

Сравнение:
  part[0]: 1 == 1  → продолжаем
  part[1]: 0 < 1   → version1 < version2 ✓ (обновление есть)
  
Результат: version1 < version2 = ИСТИНА

┌─────────────────────────────────────────┐
│ 1.0.0 → 1.0.1  (patch)      (обновить)  │
│ 1.0.0 → 1.1.0  (minor)      (обновить)  │
│ 1.0.0 → 2.0.0  (major)      (обновить)  │
│ 1.0.0 → 1.0.0  (одинаково)  (пропустить)│
│ 2.0.0 → 1.9.0  (downgrade)  (пропустить)│
└─────────────────────────────────────────┘
```

---

## 🗂️ Структура данных

### version.json
```json
{
  "current_version": "1.0.0",      // Текущая версия
  "last_check": "2025-01-15T...",  // Время последней проверки
  "update_available": false,       // Есть ли обновление
  "github_version": null,          // Версия на GitHub
  "changelog": ""                  // Описание изменений
}
```

### localStorage (JavaScript)
```javascript
{
  "dismissedUpdates": ["1.1.0", "1.2.0"]  // Отклоненные версии
}
```

### API Response (check-update)
```json
{
  "success": true,
  "update_available": true,
  "current_version": "1.0.0",
  "github_version": "1.1.0",
  "changelog": "- Fixed bugs\n- Added features",
  "last_check": "2025-01-15T12:00:00"
}
```

---

## ⚡ Производительность

```
Проверка обновлений: ~500ms (1 запрос к GitHub API)
Отображение уведомления: <100ms (DOM операции)
Git pull: ~2-5s (зависит от размера проекта)
Перезагрузка приложения: <1s

Частота проверок:
- При загрузке страницы: сразу
- Фоновая проверка: каждые 5 минут
- При возврате на вкладку: сразу

Кэширование: localStorage (отклоненные версии)
```

---

## 🐛 Отладка

### Логи в консоли браузера

```javascript
// Открыть консоль: F12 → Console

// Если видите сообщения:
✓ "Обновление было отклонено пользователем"
✓ "Обновление доступно"
✗ "Ошибка при проверке обновлений"

// Причины ошибок:
- Нет интернета
- GitHub API недоступен
- CORS ошибка
- Требуется VPN
```

### Логи сервера (Python)

```python
# В консоли приложения видите:
✓ "❌ Ошибка при получении информации о релизе: ..."
✓ "❌ Ошибка при проверке обновлений: ..."
✓ "❌ Ошибка при обновлении приложения: ..."
```

### Проверка version.json

```bash
# На сервере
cat version.json

# Должно показать:
{
  "current_version": "1.0.0",
  "github_version": "1.1.0",
  "update_available": true,
  ...
}
```

---

## 🚀 Оптимизация

```
┌──────────────────────────────────────┐
│  Текущее:                            │
│  - Проверка каждые 5 мин             │
│  - Один запрос на GitHub             │
├──────────────────────────────────────┤
│  Возможные улучшения:                │
│  ✓ ETag кэширование (GitHub)         │
│  ✓ Проверка только если изменил MD5  │
│  ✓ WebSocket для real-time updates   │
│  ✓ Batch обновления нескольких ПК    │
│  ✓ Rollback на старую версию         │
│  ✓ Планирование на ночь              │
│  ✓ Уведомления в Telegram            │
└──────────────────────────────────────┘
```

---

## 📞 Контакты для поддержки

Возникли проблемы? Проверьте:

1. **Интернет соединение** - система требует доступ в сеть
2. **Git установлен** - проверьте `git --version`
3. **Права доступа** - нужны права на запись в папку проекта
4. **Логи в консоли** - смотрите ошибки в браузере/сервере
5. **GitHub статус** - может быть недоступен из вашей сети

---

**Система обновлений готова к использованию!** 🎉
