{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h2>üì¶ –§–æ—Ä–º–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∞—Ä–µ–Ω–¥—ã</h2>
            <p class="text-muted">–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫–æ–Ω—Å–æ–ª–∏</p>
            
            <div id="rental-info" class="alert alert-info" style="display: none;">
                <p><strong>üìÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞—Ä–µ–Ω–¥–µ:</strong></p>
                <p id="rental-details"></p>
            </div>
            
            <form id="return-form" enctype="multipart/form-data">
                <input type="hidden" id="rental_id" name="rental_id">
                
                <!-- 1. –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ -->
                <div class="mb-4">
                    <label class="form-label">üéÆ –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="condition" id="excellent" value="excellent" required>
                        <label class="btn btn-outline-success" for="excellent">‚úÖ –û—Ç–ª–∏—á–Ω–æ–µ</label>
                        
                        <input type="radio" class="btn-check" name="condition" id="minor_defects" value="minor_defects">
                        <label class="btn btn-outline-info" for="minor_defects">‚ö†Ô∏è –ú–µ–ª–∫–∏–µ –¥–µ—Ñ–µ–∫—Ç—ã</label>
                        
                        <input type="radio" class="btn-check" name="condition" id="damaged" value="damaged">
                        <label class="btn btn-outline-warning" for="damaged">‚ö†Ô∏è –ü–æ–≤—Ä–µ–∂–¥—ë–Ω</label>
                        
                        <input type="radio" class="btn-check" name="condition" id="lost" value="lost">
                        <label class="btn btn-outline-danger" for="lost">‚ùå –£—Ç–µ—Ä—è–Ω</label>
                    </div>
                    <small class="form-text text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</small>
                </div>
                
                <!-- 2. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
                <div class="mb-4">
                    <label for="admin_comment" class="form-label">üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
                    <textarea class="form-control" id="admin_comment" name="admin_comment" rows="3" 
                              placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–æ–≤, –∑–∞–º–µ—á–∞–Ω–∏–π –∏–ª–∏ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π –≤–æ–∑–≤—Ä–∞—Ç–∞..."></textarea>
                    <small class="form-text text-muted">–ù–∞–ø—Ä–∏–º–µ—Ä: —Ü–∞—Ä–∞–ø–∏–Ω—ã –Ω–∞ –∫–æ—Ä–ø—É—Å–µ, –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–Ω–æ–ø–∫–∞ –ø–∏—Ç–∞–Ω–∏—è –∏ —Ç.–¥.</small>
                </div>
                
                <!-- 3. –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
                <div class="mb-4">
                    <label for="return_photos" class="form-label">üì∏ –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞</label>
                    <div class="input-group">
                        <input type="file" class="form-control" id="return_photos" name="return_photos" 
                               accept="image/*" multiple>
                        <label class="input-group-text" for="return_photos">–í—ã–±—Ä–∞—Ç—å</label>
                    </div>
                    <small class="form-text text-muted">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–¥–Ω—É –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–æ–≤–∞—Ä–∞</small>
                    
                    <!-- –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π -->
                    <div id="photos-preview" class="mt-3">
                        <!-- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
                    </div>
                </div>
                
                <!-- 4. –î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
                <div class="mb-4">
                    <label for="return_date" class="form-label">üìÖ –î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ *</label>
                    <input type="datetime-local" class="form-control" id="return_date" name="return_date" required>
                    <small class="form-text text-muted">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ç–æ–≤–∞—Ä–∞</small>
                </div>
                
                <!-- 5. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞ -->
                <div class="mb-4">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="client_confirmed" name="client_confirmed">
                        <label class="form-check-label" for="client_confirmed">
                            ‚úì <strong>–ö–ª–∏–µ–Ω—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —Å–¥–∞—á—É —Ç–æ–≤–∞—Ä–∞</strong>
                        </label>
                    </div>
                    <small class="form-text text-muted">–û—Ç–º–µ—Ç—å—Ç–µ, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ª–∏—á–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –≤–æ–∑–≤—Ä–∞—Ç —Ç–æ–≤–∞—Ä–∞ –≤ —Ö–æ—Ä–æ—à–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏</small>
                </div>
                
                <!-- –ü–æ–¥–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–∞ (–µ—Å–ª–∏ –æ—Ñ–ª–∞–π–Ω) -->
                <div class="mb-4" id="signature-section" style="display: none;">
                    <label for="client_signature" class="form-label">‚úçÔ∏è –ü–æ–¥–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–∞ (–æ—Ñ–ª–∞–π–Ω)</label>
                    <div id="signature-pad" style="border: 2px dashed #ccc; border-radius: 5px; cursor: crosshair; height: 200px;"></div>
                    <canvas id="signatureCanvas" width="400" height="200" style="border: 2px dashed #ccc; border-radius: 5px; display: none;"></canvas>
                    <input type="hidden" id="client_signature" name="client_signature">
                    <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="clearSignature()">–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å—å</button>
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∏ -->
                <div class="mb-4">
                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        ‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–æ–∑–≤—Ä–∞—Ç
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏ -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>

<script>
let signaturePad = null;
let rentalId = new URLSearchParams(window.location.search).get('rental_id');

document.addEventListener('DOMContentLoaded', function() {
    // –ü–æ–ª—É—á–∞–µ–º ID –∞—Ä–µ–Ω–¥—ã –∏–∑ URL –∏–ª–∏ –ø–µ—Ä–µ–¥–∞—ë–º –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä
    if (rentalId) {
        document.getElementById('rental_id').value = rentalId;
        loadRentalInfo(rentalId);
    }
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
    const now = new Date();
    const localDateTime = now.toISOString().slice(0, 16);
    document.getElementById('return_date').value = localDateTime;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å—å
    initializeSignature();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Ä–∞–∑–¥–µ–ª –ø–æ–¥–ø–∏—Å–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —á–µ–∫–±–æ–∫—Å
    document.getElementById('client_confirmed').addEventListener('change', function() {
        document.getElementById('signature-section').style.display = 
            this.checked ? 'block' : 'none';
        if (this.checked && signaturePad) {
            setTimeout(() => signaturePad.resizeCanvas(), 100);
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
    document.getElementById('return_photos').addEventListener('change', handlePhotoUpload);
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    document.getElementById('return-form').addEventListener('submit', submitReturnForm);
});

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞—Ä–µ–Ω–¥–µ
function loadRentalInfo(rentalId) {
    fetch(`/api/rental-info/${rentalId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.rental) {
                const rental = data.rental;
                document.getElementById('rental-details').innerHTML = `
                    <strong>ID –∞—Ä–µ–Ω–¥—ã:</strong> ${rental.rental_id}<br>
                    <strong>–ö–æ–Ω—Å–æ–ª—å:</strong> ${rental.console_id}<br>
                    <strong>–ö–ª–∏–µ–Ω—Ç:</strong> ${rental.user_id}<br>
                    <strong>–ù–∞—á–∞–ª–æ –∞—Ä–µ–Ω–¥—ã:</strong> ${rental.start_date}<br>
                    <strong>–ö–æ–Ω–µ—Ü –∞—Ä–µ–Ω–¥—ã:</strong> ${rental.end_date}
                `;
                document.getElementById('rental-info').style.display = 'block';
            }
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞:', error));
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏
function initializeSignature() {
    const canvas = document.getElementById('signatureCanvas');
    if (canvas) {
        signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgba(255,255,255,0)',
            penColor: '#000000',
            minWidth: 1,
            maxWidth: 3,
            velocityFilterWeight: 0.7,
            minDistance: 5,
            dotSize: 3,
            throttle: 16,
            minThickness: 1,
            maxThickness: 2,
            canvasContextOptions: {},
            onBegin: () => {},
            onEnd: () => {}
        });
    }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
function handlePhotoUpload(e) {
    const files = e.target.files;
    const preview = document.getElementById('photos-preview');
    preview.innerHTML = '';
    
    if (files.length > 0) {
        preview.innerHTML = '<p class="text-muted">üì∏ –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏:</p>';
        
        Array.from(files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.style.maxWidth = '150px';
                img.style.maxHeight = '150px';
                img.style.margin = '5px';
                img.style.borderRadius = '5px';
                img.style.border = '1px solid #ddd';
                
                const div = document.createElement('div');
                div.style.display = 'inline-block';
                div.appendChild(img);
                preview.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    }
}

// –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å—å
function clearSignature() {
    if (signaturePad) {
        signaturePad.clear();
    }
}

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É –≤–æ–∑–≤—Ä–∞—Ç–∞
function submitReturnForm(e) {
    e.preventDefault();
    
    const rentalId = document.getElementById('rental_id').value;
    const condition = document.querySelector('input[name="condition"]:checked').value;
    const adminComment = document.getElementById('admin_comment').value;
    const returnDate = document.getElementById('return_date').value;
    const clientConfirmed = document.getElementById('client_confirmed').checked;
    
    if (!rentalId || !condition || !returnDate) {
        alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–æ—Ç–º–µ—á–µ–Ω—ã *)');
        return;
    }
    
    // –ü–æ–ª—É—á–∏—Ç—å –ø–æ–¥–ø–∏—Å—å –µ—Å–ª–∏ –æ–Ω–∞ –Ω—É–∂–Ω–∞
    let clientSignature = '';
    if (clientConfirmed && signaturePad && !signaturePad.isEmpty()) {
        clientSignature = signaturePad.toDataURL();
    }
    
    // –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    const formData = new FormData();
    formData.append('rental_id', rentalId);
    formData.append('condition', condition);
    formData.append('admin_comment', adminComment);
    formData.append('return_date', returnDate);
    formData.append('client_confirmed', clientConfirmed);
    formData.append('client_signature', clientSignature);
    
    // –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
    const photosInput = document.getElementById('return_photos');
    if (photosInput.files.length > 0) {
        Array.from(photosInput.files).forEach((file, index) => {
            formData.append(`return_photos`, file);
        });
    }
    
    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å
    fetch('/api/return-rental', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('‚úÖ –í–æ–∑–≤—Ä–∞—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!');
            // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É –∏–ª–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å
            document.getElementById('return-form').reset();
            setTimeout(() => {
                window.location.href = '/admin';
            }, 1500);
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + result.message);
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã');
    });
}

// –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ç–æ –ø—Ä–µ–≤—å—é
const style = document.createElement('style');
style.textContent = `
    #photos-preview {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .btn-group {
        display: flex;
    }
    
    .btn-group .btn-check + .btn {
        flex: 1;
    }
    
    canvas {
        cursor: crosshair;
        touch-action: none;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
